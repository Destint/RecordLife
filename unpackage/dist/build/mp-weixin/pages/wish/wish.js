"use strict";var e=require("../../common/vendor.js"),t=require("../../common/commonFunctions.js");const i=e.pn.database(),a=e.pn.importObject("serverDate",{customUI:!0}),n=getApp(),o={data:()=>({isShowPopup:!1,notice:e.index.getStorageSync(n.globalData.noticeCacheName)?e.index.getStorageSync(n.globalData.noticeCacheName):"",wishSum:e.index.getStorageSync(n.globalData.wishSumCacheName)?e.index.getStorageSync(n.globalData.wishSumCacheName):0,wishList:e.index.getStorageSync(n.globalData.wishCacheName)?e.index.getStorageSync(n.globalData.wishCacheName):[],isShowAddWishView:!1,addWishContent:""}),async onLoad(){e.index.showLoading({title:"载入心愿中",mask:!0}),n.globalData.wx_openid||await t.commonFunctions.wxLogin(),await this.getWishFromCloud(n.globalData.wx_openid,0),e.index.hideLoading()},async onPullDownRefresh(){let t=this;try{e.index.showLoading({title:"更新心愿中",mask:!0}),t.getNoticeFromCloud(),await t.getWishFromCloud(n.globalData.wx_openid,0),e.index.stopPullDownRefresh(),e.index.hideLoading()}catch(i){}},async onReachBottom(){let t=this;try{let i=t.wishList.length;i===t.wishSum?e.index.showToast({title:"心愿到底啦",icon:"none"}):(e.index.showLoading({title:"载入心愿中",mask:!0}),await t.getWishFromCloud(n.globalData.wx_openid,i),e.index.hideLoading())}catch(i){}},onShareAppMessage:()=>({title:"记录关于你的回忆",path:"/pages/memory/memory",imageUrl:"https://vkceyugu.cdn.bspapp.com/VKCEYUGU-bcf64df9-4d03-4023-bc85-9000afa0f691/e989c0a9-706c-4c3c-8020-3c04a0e2344d.png"}),methods:{async getNoticeFromCloud(){let t=this;try{await i.collection("notice").where("_id == '62f49bb51ff3ac000168404b'").get().then((i=>{if(0===i.result.errCode){let a=i.result.data[0].noticeList[0].notice;a!==e.index.getStorageSync(n.globalData.noticeCacheName)&&(t.notice=a,e.index.setStorageSync(n.globalData.noticeCacheName,a))}})).catch()}catch(a){}},async getWishFromCloud(t,a){let o=this;try{await i.collection("wish").where("wx_openid == '"+t+"'").get().then((t=>{if(0===t.result.errCode){let i=t.result.data[0]?t.result.data[0].wishList:[],s=i.slice(a,a+30),h=i.length;0===a?(o.wishList=o.handleWishDuration(s),o.wishSum=h,e.index.setStorageSync(n.globalData.wishCacheName,s),e.index.setStorageSync(n.globalData.wishSumCacheName,h)):o.wishList=o.handleWishDuration(o.wishList.concat(s))}})).catch()}catch(s){}},onClickAddWish(){let e=this;e.isShowPopup=!0,e.isShowAddWishView=!0,e.addWishContent=""},onClickAddWishMask(){let e=this;e.addWishContent="",e.isShowAddWishView=!1,e.isShowPopup=!1},inputWishContent(e){this.addWishContent=e.target.value},async onClickUploadWish(){let o=this;try{let s=o.addWishContent;if(!s)return void e.index.showToast({title:"心愿不能为空",icon:"none"});e.index.showModal({title:"温馨提示",content:"是否添加该心愿",success:async h=>{if(h.confirm){e.index.showLoading({title:"添加中...",mask:!0});let h=await t.commonFunctions.checkContentSecurity(s);if(0!==h.errCode)e.index.hideLoading(),e.index.showModal({title:"温馨提示",content:h.errMsg,showCancel:!1});else{let t={id:0,content:"",startDate:"",endDate:"",state:0},h=await a.getCurrentDate();t.id=h.data.currentId,t.content=s,t.startDate=h.data.currentDate,t.endDate="",t.state=0,await i.collection("wish").where("wx_openid == '"+n.globalData.wx_openid+"'").get().then((async a=>{if(0===a.result.errCode){let s=a.result.data[0]?a.result.data[0].wishList:[];s.unshift(t),0===a.result.data.length?await i.collection("wish").add({wx_openid:n.globalData.wx_openid,wishList:s}).then((()=>{o.wishList=o.handleWishDuration(s.slice(0,30)),o.wishSum=s.length,e.index.setStorageSync(n.globalData.wishCacheName,s.slice(0,30)),e.index.setStorageSync(n.globalData.wishSumCacheName,s.length)})).catch():await i.collection("wish").where("wx_openid == '"+n.globalData.wx_openid+"'").update({wishList:s}).then((()=>{o.wishList=o.handleWishDuration(s.slice(0,30)),o.wishSum=s.length,e.index.setStorageSync(n.globalData.wishCacheName,s.slice(0,30)),e.index.setStorageSync(n.globalData.wishSumCacheName,s.length)})).catch()}})).catch(),o.onClickAddWishMask(),e.index.hideLoading(),e.index.showToast({title:"添加成功",icon:"none"})}}}})}catch(s){o.onClickAddWishMask(),e.index.hideLoading()}},onClickEditorWish(t){let i=this;try{0===t.state?e.index.showActionSheet({itemList:["完成心愿","放弃心愿","删除心愿"],success:e=>{0===e.tapIndex?i.editorWish(t,1):1===e.tapIndex?i.editorWish(t,-1):2===e.tapIndex&&i.editorWish(t,0)},fail:()=>{}}):e.index.showActionSheet({itemList:["删除心愿"],success:e=>{0===e.tapIndex&&i.editorWish(t,0)},fail:()=>{}})}catch(a){}},editorWish(t,o){let s=this;try{let h=0===o?"删除":1===o?"完成":"放弃";e.index.showModal({title:"温馨提示",content:"确定"+h+"该心愿吗",success:async d=>{d.confirm&&(e.index.showLoading({title:h+"中...",mask:!0}),await i.collection("wish").where("wx_openid == '"+n.globalData.wx_openid+"'").get().then((async h=>{if(0===h.result.errCode){let d=h.result.data[0]?h.result.data[0].wishList:[],c=d.findIndex((function(e){return e.id===t.id})),l=await a.getCurrentDate();0===o?d.splice(c,1):(d[c].endDate=l.data.currentDate,d[c].state=o),0!==d.length?await i.collection("wish").where("wx_openid == '"+n.globalData.wx_openid+"'").update({wishList:d}).then().catch():await i.collection("wish").where("wx_openid == '"+n.globalData.wx_openid+"'").remove(),s.wishList=s.handleWishDuration(d.slice(0,30)),s.wishSum=d.length,e.index.setStorageSync(n.globalData.wishCacheName,d.slice(0,30)),e.index.setStorageSync(n.globalData.wishSumCacheName,d.length)}})).catch(),e.index.hideLoading(),e.index.showToast({title:"已"+h+"心愿",icon:"none"}))}})}catch(h){e.index.hideLoading()}},handleWishDuration(e){try{for(let t=0;t<e.length;t++){let i=e[t].startDate,a=e[t].endDate;if(0!==e[t].state&&i&&a){let n="",o=(new Date(a.replace(/-/g,"/")).getTime()-new Date(i.replace(/-/g,"/")).getTime())/1e3;o<60?n=o.toFixed(1)+"秒":(o/=60,o<60?n=o.toFixed(1)+"分钟":(o/=60,n=o<24?o.toFixed(1)+"小时":(o/24).toFixed(1)+"天")),e[t].duration=n}}return e}catch(t){return e}}}};var s=e._export_sfc(o,[["render",function(t,i,a,n,o,s){return e.e({a:"overflow:"+(o.isShowPopup?"hidden":"visible"),b:e.t(o.notice),c:e.t(o.wishSum),d:o.wishSum>0},o.wishSum>0?{e:e.f(o.wishList,((t,i,a)=>e.e({a:e.t(t.content),b:e.s("text-decoration:"+(0!==t.state?"line-through":"")),c:e.t(t.startDate),d:0!==t.state},0!==t.state?{e:e.t(t.endDate),f:1===t.state?"../../static/img_wish_finish_icon.png":"../../static/img_wish_give_up_icon.png",g:e.t(t.duration)}:{},{h:e.o((e=>s.onClickEditorWish(t))),i:e.s("margin-top:"+(0===i?"-70rpx":"20rpx")),j:i})))}:{},{f:e.o(((...e)=>s.onClickAddWish&&s.onClickAddWish(...e))),g:!0===o.isShowAddWishView},!0===o.isShowAddWishView?{h:e.o(((...e)=>s.onClickAddWishMask&&s.onClickAddWishMask(...e))),i:e.o(((...e)=>s.inputWishContent&&s.inputWishContent(...e))),j:e.o(((...e)=>s.onClickUploadWish&&s.onClickUploadWish(...e)))}:{})}]]);o.__runtimeHooks=2,wx.createPage(s);
