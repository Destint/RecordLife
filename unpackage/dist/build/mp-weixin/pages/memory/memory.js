"use strict";var e=require("../../common/vendor.js"),t=require("../../common/commonFunctions.js");const a=new(require("../../common/qqmap-wx-jssdk.js").QQMapWX)({key:"3XKBZ-WP4CG-KQVQM-IJ2WK-7QAE7-2ZFKZ"}),o=e.rn.importObject("serverDate",{customUI:!0}),i=e.rn.importObject("handleMemory",{customUI:!0}),l=e.rn.database(),r=getApp();var c=!1;const n={data:()=>({notice:e.index.getStorageSync(r.globalData.noticeCacheName)?e.index.getStorageSync(r.globalData.noticeCacheName):"",memorySum:e.index.getStorageSync(r.globalData.memorySumCacheName)?e.index.getStorageSync(r.globalData.memorySumCacheName):0,memoryList:e.index.getStorageSync(r.globalData.memoryCacheName)?e.index.getStorageSync(r.globalData.memoryCacheName):[],isShowPopup:!1,memoryDetail:{},isShowMemoryDetail:!1,isShowAddMemory:!1}),async onLoad(){let a=this;e.index.showLoading({title:"载入回忆中",mask:!0}),r.globalData.wx_openid||await t.commonFunctions.wxLogin(),a.uploadAccessToCloud(r.globalData.wx_openid),a.getNoticeFromCloud(),await a.getMemoryFromCloud(r.globalData.wx_openid,0),e.index.hideLoading()},async onPullDownRefresh(){let t=this;try{e.index.showLoading({title:"更新回忆中",mask:!0}),t.getNoticeFromCloud(),await t.getMemoryFromCloud(r.globalData.wx_openid,0),e.index.stopPullDownRefresh(),e.index.hideLoading()}catch(a){}},async onReachBottom(){let t=this;try{let a=t.memoryList.length;a===t.memorySum?e.index.showToast({title:"回忆到底啦",icon:"none"}):(e.index.showLoading({title:"载入回忆中",mask:!0}),await t.getMemoryFromCloud(r.globalData.wx_openid,a),e.index.hideLoading())}catch(a){}},onShareAppMessage:()=>({title:"记录关于你的回忆",path:"/pages/memory/memory",imageUrl:"https://vkceyugu.cdn.bspapp.com/VKCEYUGU-bcf64df9-4d03-4023-bc85-9000afa0f691/e989c0a9-706c-4c3c-8020-3c04a0e2344d.png"}),methods:{async uploadAccessToCloud(e){if(e)try{await l.collection("access").where("wx_openid == '"+e+"'").get().then((async t=>{if(0===t.result.errCode){let a=t.result.data[0]?t.result.data[0].accessList:[],i=await o.getCurrentDate();a.slice(0,99),a.unshift(i.data.currentDate),0===t.result.data.length?await l.collection("access").add({wx_openid:e,accessList:a}).then().catch():await l.collection("access").where("wx_openid == '"+e+"'").update({accessList:a})}})).catch()}catch(t){}},async getNoticeFromCloud(){let t=this;try{await l.collection("notice").where("_id == '62f49bb51ff3ac000168404b'").get().then((a=>{if(0===a.result.errCode){let o=a.result.data[0].noticeList[0].notice;o!==e.index.getStorageSync(r.globalData.noticeCacheName)&&(t.notice=o,e.index.setStorageSync(r.globalData.noticeCacheName,o))}})).catch()}catch(a){}},async getMemoryFromCloud(t,a){let o=this;try{await l.collection("memory").where("wx_openid == '"+t+"'").get().then((t=>{if(0===t.result.errCode){let i=t.result.data[0]?t.result.data[0].memoryList:[],l=i.slice(a,a+15),c=i.length;0===a?(o.memoryList=l,o.memorySum=c,e.index.setStorageSync(r.globalData.memoryCacheName,l),e.index.setStorageSync(r.globalData.memorySumCacheName,c)):o.memoryList=o.memoryList.concat(l)}})).catch()}catch(i){}},onClickMemoryCell(e){let t=this;t.isShowPopup=!0,t.memoryDetail=e,t.isShowMemoryDetail=!0},onClickEditorMemory(t){let a=this;try{e.index.showActionSheet({itemList:["删除该回忆"],success:e=>{0===e.tapIndex&&a.deleteMemory(t)},fail:()=>{}})}catch(o){}},onClickAddMemory(){let e=this;e.isShowPopup=!0,e.memoryDetail={title:"",localPicPathList:[],cloudPicPathList:[],content:"",address:"",simpleAddress:"",id:0,date:""},e.isShowAddMemory=!0},onClickMemoryDetailMask(){let e=this;e.isShowMemoryDetail=!1,e.isShowPopup=!1,e.memoryDetail={}},onPreviewMemoryCellPic(t,a){let o=this;try{let i="cloud"===t?o.memoryDetail.cloudPicPathList:o.memoryDetail.localPicPathList,l=i&&i[a]?i[a]:"",r=[];if(!l)return;for(let e=0;e<i.length;e++)i[e]&&r.push(i[e]);e.index.previewImage({current:l,urls:r})}catch(i){}},inputMemoryTitle(e){this.memoryDetail.title=e.target.value},onClickDeletePic(e){this.memoryDetail.localPicPathList.splice(e,1)},async onClickAddPic(){let t=this;try{let a=t.memoryDetail.localPicPathList;if(a.length>=5)e.index.showToast({title:"图片最多记录5张",icon:"none"});else{let o=await e.index.chooseImage({count:5-a.length,sizeType:["compressed"],sourceType:["album"]});e.index.showLoading({title:"图片选择中...",mask:!0});let i=o.tempFiles;i=await t.compressImgList(o.tempFiles);for(let t=0;t<i.length;t++){let a=await e.index.compressImage({src:i[t],quality:80});i[t]=a.tempFilePath}t.memoryDetail.localPicPathList=a.concat(i),e.index.hideLoading()}}catch(a){}},async compressImgList(t){let a=this;try{let o=[];for(let i=0;i<t.length;i++){if(t[i].size/1024<500){o.push(t[i].path);continue}let l=await e.index.getImageInfo({src:t[i].path}),r=new Promise((t=>{e.index.createSelectorQuery().select("#myCanvas").fields({node:!0,size:!0}).exec((e=>{const i=e[0].node,r=i.getContext("2d"),c=l.height/l.width;i.width=l.width>750?750:l.width,i.height=i.width*c;let n=i.createImage();n.src=l.path,n.onload=()=>{r.drawImage(n,0,0,i.width,i.height),wx.canvasToTempFilePath({canvas:i,fileType:"jpg",success:e=>{o.push(e.tempFilePath),t(!0)},fail:()=>{t(!0)}},a)},n.onerror=()=>{t(!0)}}))}));await r}return o}catch(o){}},inputMemoryContent(e){this.memoryDetail.content=e.target.value},onClickAddMemoryBack(){let t=this;e.index.showModal({title:"温馨提示",content:"返回会清空当前正记录的回忆哦",success:e=>{e.confirm&&(t.memoryDetail={},t.isShowAddMemory=!1,t.isShowPopup=!1)}})},onClickAddMemoryWrite(){let a=this;try{let o=a.memoryDetail;if(""===o.title)return void e.index.showToast({title:"回忆标题不能为空",icon:"none"});if(!0===c)return;c=!0,e.index.showModal({title:"温馨提示",content:"是否记录当前回忆",success:async i=>{if(i.confirm){let i=o.title+o.content;e.index.showLoading({title:"记录中...",mask:!0});let l=await t.commonFunctions.checkContentSecurity(i);0!==l.errCode?(e.index.hideLoading(),e.index.showModal({title:"温馨提示",content:l.errMsg,showCancel:!1,success:()=>{c=!1}})):await a.startWriteMemory()}i.cancel&&(c=!1)}})}catch(o){e.index.showModal({title:"温馨提示",content:"记录回忆失败请重试",showCancel:!1,success:e=>{e.confirm&&(c=!1)}})}},async startWriteMemory(){let t=this;try{await t.getCurrentAddressInfo(),await t.setMemoryIdAndDate(),await t.uploadLocalFileToCloud(),await t.uploadMemoryToCloud(),t.memoryDetail={},t.isShowAddMemory=!1,t.isShowPopup=!1,c=!1,e.index.hideLoading(),e.index.showToast({title:"记录成功",icon:"none"})}catch(a){e.index.hideLoading(),e.index.showModal({title:"温馨提示",content:"记录回忆失败，请重试",showCancel:!1,success:()=>{c=!1}})}},async getCurrentAddressInfo(){let e=this;try{let t=new Promise((t=>{wx.startLocationUpdate({success:()=>{wx.onLocationChange((async a=>{wx.offLocationChange(),wx.stopLocationUpdate(),await e.getCurrentLocation(a.latitude,a.longitude),t(!0)}))},fail:e=>{t(!0)}})}));await t}catch(t){}},async getCurrentLocation(e,t){let o=this;try{let i=new Promise((i=>{a.reverseGeocoder({location:{latitude:e,longitude:t},success:async e=>{if(e&&e.result){let t=e.result.address?e.result.address:"",a=e.result.ad_info.city?e.result.ad_info.city:"",i=e.result.ad_info.district?e.result.ad_info.district:"",l=i||a;await o.getCurrentWeather(l,t)}i(!0)},fail:()=>{i(!0)}})}));await i}catch(i){}},async getCurrentWeather(t,a){let o=this;try{let i=new Promise((i=>{e.index.request({url:"https://free-api.heweather.net/s6/weather/now",data:{location:t,key:"2ce65b27e7784d0f85ecd7b8127f5e2d"},success:e=>{let l=e.data.HeWeather6[0].now.cond_txt,r=e.data.HeWeather6[0].now.fl+"℃";o.memoryDetail.address=a+" "+l+" "+r,o.memoryDetail.simpleAddress=t+" "+l+" "+r,i(!0)},fail:()=>{i(!0)}})}));await i}catch(i){}},async setMemoryIdAndDate(){let e=this;try{let t=await o.getCurrentDate();0===t.errCode&&(e.memoryDetail.id=t.data.currentId,e.memoryDetail.date=t.data.currentDate)}catch(t){}},async uploadLocalFileToCloud(){let t=this;try{if(0===t.memoryDetail.localPicPathList.length)return;let a=t.memoryDetail.id,o=t.memoryDetail.localPicPathList,i=[];for(let l=0;l<o.length;l++)i.push(new Promise((i=>{e.rn.uploadFile({filePath:o[l],cloudPath:r.globalData.wx_openid+"."+a+l+".jpg"}).then((e=>{t.memoryDetail.cloudPicPathList[l]=e.fileID,i(!0)})).catch((e=>{t.memoryDetail.cloudPicPathList[l]="",i(!0)}))})));await Promise.all(i).then((()=>{})).catch((()=>{}))}catch(a){}},async uploadMemoryToCloud(){let t=this;try{await l.collection("memory").where("wx_openid == '"+r.globalData.wx_openid+"'").get().then((async a=>{if(0===a.result.errCode){let o=a.result.data[0]?a.result.data[0].memoryList:[];o.unshift(t.memoryDetail),0===a.result.data.length?await l.collection("memory").add({wx_openid:r.globalData.wx_openid,memoryList:o}).then((()=>{t.memoryList=o.slice(0,15),t.memorySum=o.length,e.index.setStorageSync(r.globalData.memoryCacheName,o.slice(0,15)),e.index.setStorageSync(r.globalData.memorySumCacheName,o.length)})).catch():await l.collection("memory").where("wx_openid == '"+r.globalData.wx_openid+"'").update({memoryList:o}).then((()=>{t.memoryList=o.slice(0,15),t.memorySum=o.length,e.index.setStorageSync(r.globalData.memoryCacheName,o.slice(0,15)),e.index.setStorageSync(r.globalData.memorySumCacheName,o.length)})).catch()}})).catch()}catch(a){}},deleteMemory(t){if(t)try{let a=this;e.index.showModal({title:"温馨提示",content:"是否删除回忆《"+t.title+"》",success:async o=>{if(o.confirm){e.index.showLoading({title:"删除中...",mask:!0});let o=await i.deleteMemory(r.globalData.wx_openid,t.id);0===o.errCode?(a.memoryList=o.data.memoryList.slice(0,15),a.memorySum=o.data.memoryList.length,e.index.setStorageSync(r.globalData.memoryCacheName,o.data.memoryList.slice(0,15)),e.index.setStorageSync(r.globalData.memorySumCacheName,o.data.memoryList.length),e.index.hideLoading(),e.index.showToast({title:"删除成功",icon:"none"})):(e.index.hideLoading(),e.index.showToast({title:"删除失败",icon:"none"}))}}})}catch(a){}}}};var s=e._export_sfc(n,[["render",function(t,a,o,i,l,r){return e.e({a:"overflow:"+(l.isShowPopup?"hidden":"visible"),b:e.t(l.notice),c:e.t(l.memorySum),d:l.memorySum>0},l.memorySum>0?{e:e.f(l.memoryList,((t,a,o)=>e.e({a:e.t(t.title),b:e.t(t.content),c:t.cloudPicPathList.length>0},t.cloudPicPathList.length>0?{d:e.f(t.cloudPicPathList,((t,a,o)=>({a:t||"../../static/img_empty_icon.png",b:e.s("margin-left:"+(0===a?"0rpx":"5rpx")),c:a})))}:{},{e:e.t(t.date+"    "+t.simpleAddress),f:e.o((e=>r.onClickEditorMemory(t))),g:e.s("margin-top:"+(0===a?"-70rpx":"20rpx")),h:e.o((e=>r.onClickMemoryCell(t))),i:a})))}:{},{f:e.o(((...e)=>r.onClickAddMemory&&r.onClickAddMemory(...e))),g:!0===l.isShowMemoryDetail},!0===l.isShowMemoryDetail?e.e({h:e.o(((...e)=>r.onClickMemoryDetailMask&&r.onClickMemoryDetailMask(...e))),i:e.t(l.memoryDetail.title),j:l.memoryDetail.cloudPicPathList.length>0},l.memoryDetail.cloudPicPathList.length>0?{k:e.f(l.memoryDetail.cloudPicPathList,((t,a,o)=>({a:t||"../../static/img_empty_icon.png",b:e.o((e=>r.onPreviewMemoryCellPic("cloud",a))),c:e.s("margin-left:"+((a+1)%5==1?"0rpx":"10rpx")+";margin-top:"+(a>4?"5rpx":"0rpx")),d:a})))}:{},{l:l.memoryDetail.content},l.memoryDetail.content?{m:e.t(l.memoryDetail.content)}:{},{n:l.memoryDetail.date},l.memoryDetail.date?{o:e.t(l.memoryDetail.date)}:{},{p:l.memoryDetail.address&&" "!==l.memoryDetail.address},l.memoryDetail.address&&" "!==l.memoryDetail.address?{q:e.t(l.memoryDetail.address)}:{}):{},{r:!0===l.isShowAddMemory},!0===l.isShowAddMemory?e.e({s:e.o(((...e)=>r.inputMemoryTitle&&r.inputMemoryTitle(...e))),t:l.memoryDetail.localPicPathList.length>0},l.memoryDetail.localPicPathList.length>0?{v:e.f(l.memoryDetail.localPicPathList,((t,a,o)=>({a:t||"../../static/img_empty_icon.png",b:e.o((e=>r.onPreviewMemoryCellPic("local",a))),c:e.o((e=>r.onClickDeletePic(a))),d:e.s("margin-left:"+((a+1)%5==1?"0rpx":"10rpx")+";margin-top:"+(a>4?"5rpx":"0rpx")),e:a})))}:{},{w:l.memoryDetail.localPicPathList.length<5},l.memoryDetail.localPicPathList.length<5?{x:e.s("margin-left:"+(l.memoryDetail.localPicPathList.length>0?"10rpx":"0rpx")+";"),y:e.o(((...e)=>r.onClickAddPic&&r.onClickAddPic(...e)))}:{},{z:e.o(((...e)=>r.inputMemoryContent&&r.inputMemoryContent(...e))),A:e.o(((...e)=>r.onClickAddMemoryBack&&r.onClickAddMemoryBack(...e))),B:e.o(((...e)=>r.onClickAddMemoryWrite&&r.onClickAddMemoryWrite(...e)))}):{})}]]);n.__runtimeHooks=2,wx.createPage(s);
