"use strict";var e=require("../../common/vendor.js"),t=require("../../common/commonFunctions.js");const o=new(require("../../common/qqmap-wx-jssdk.js").QQMapWX)({key:"3XKBZ-WP4CG-KQVQM-IJ2WK-7QAE7-2ZFKZ"}),a=e.rn.importObject("serverDate",{customUI:!0}),i=e.rn.importObject("handleMemory",{customUI:!0}),l=e.rn.database(),r=getApp();var c=!1;const n={data:()=>({notice:e.index.getStorageSync(r.globalData.noticeCacheName)?e.index.getStorageSync(r.globalData.noticeCacheName):"",memorySum:e.index.getStorageSync(r.globalData.memorySumCacheName)?e.index.getStorageSync(r.globalData.memorySumCacheName):0,memoryList:e.index.getStorageSync(r.globalData.memoryCacheName)?e.index.getStorageSync(r.globalData.memoryCacheName):[],isShowPopup:!1,memoryDetail:{},isShowMemoryDetail:!1,isShowAddMemory:!1}),async onLoad(){let o=this;e.index.showLoading({title:"载入回忆中",mask:!0}),r.globalData.wx_openid||await t.commonFunctions.wxLogin(),o.uploadAccessToCloud(r.globalData.wx_openid),o.getNoticeFromCloud(),await o.getMemoryFromCloud(r.globalData.wx_openid,0),e.index.hideLoading()},async onPullDownRefresh(){let t=this;try{e.index.showLoading({title:"更新回忆中",mask:!0}),t.getNoticeFromCloud(),await t.getMemoryFromCloud(r.globalData.wx_openid,0),e.index.stopPullDownRefresh(),e.index.hideLoading()}catch(o){}},async onReachBottom(){let t=this;try{let o=t.memoryList.length;o===t.memorySum?e.index.showToast({title:"回忆到底啦",icon:"none"}):(e.index.showLoading({title:"载入回忆中",mask:!0}),await t.getMemoryFromCloud(r.globalData.wx_openid,o),e.index.hideLoading())}catch(o){}},onShareAppMessage:()=>({title:"记录关于你的回忆",path:"/pages/memory/memory",imageUrl:"https://vkceyugu.cdn.bspapp.com/VKCEYUGU-bcf64df9-4d03-4023-bc85-9000afa0f691/e989c0a9-706c-4c3c-8020-3c04a0e2344d.png"}),methods:{async uploadAccessToCloud(e){if(e)try{await l.collection("access").where("wx_openid == '"+e+"'").get().then((async t=>{if(0===t.result.errCode){let o=t.result.data[0]?t.result.data[0].accessList:[],i=await a.getCurrentDate();o.slice(0,99),o.unshift(i.data.currentDate),0===t.result.data.length?await l.collection("access").add({wx_openid:e,accessList:o}).then().catch():await l.collection("access").where("wx_openid == '"+e+"'").update({accessList:o})}})).catch()}catch(t){}},async getNoticeFromCloud(){let t=this;try{await l.collection("notice").where("_id == '62f49bb51ff3ac000168404b'").get().then((o=>{if(0===o.result.errCode){let a=o.result.data[0].noticeList[0].notice;a!==e.index.getStorageSync(r.globalData.noticeCacheName)&&(t.notice=a,e.index.setStorageSync(r.globalData.noticeCacheName,a))}})).catch()}catch(o){}},async getMemoryFromCloud(t,o){let a=this;try{await l.collection("memory").where("wx_openid == '"+t+"'").get().then((t=>{if(0===t.result.errCode){let i=t.result.data[0]?t.result.data[0].memoryList:[],l=i.slice(o,o+15),c=i.length;0===o?(a.memoryList=l,a.memorySum=c,e.index.setStorageSync(r.globalData.memoryCacheName,l),e.index.setStorageSync(r.globalData.memorySumCacheName,c)):a.memoryList=a.memoryList.concat(l)}})).catch()}catch(i){}},onClickMemoryCell(e){let t=this;t.isShowPopup=!0,t.memoryDetail=e,t.isShowMemoryDetail=!0},onClickEditorMemory(t){let o=this;try{e.index.showActionSheet({itemList:["删除该回忆"],success:e=>{0===e.tapIndex&&o.deleteMemory(t)},fail:()=>{}})}catch(a){}},onClickAddMemory(){let e=this;e.isShowPopup=!0,e.memoryDetail={title:"",localPicPathList:[],cloudPicPathList:[],content:"",address:"",simpleAddress:"",id:0,date:""},e.isShowAddMemory=!0},onClickMemoryDetailMask(){let e=this;e.isShowMemoryDetail=!1,e.isShowPopup=!1,e.memoryDetail={}},onPreviewMemoryCellPic(t,o){let a=this;try{let i="cloud"===t?a.memoryDetail.cloudPicPathList:a.memoryDetail.localPicPathList,l=i&&i[o]?i[o]:"",r=[];if(!l)return;for(let e=0;e<i.length;e++)i[e]&&r.push(i[e]);e.index.previewImage({current:l,urls:r})}catch(i){}},inputMemoryTitle(e){this.memoryDetail.title=e.target.value},onClickDeletePic(e){this.memoryDetail.localPicPathList.splice(e,1)},async onClickAddPic(){let t=this;try{let o=t.memoryDetail.localPicPathList;if(o.length>=5)e.index.showToast({title:"图片最多记录5张",icon:"none"});else{let a=(await e.index.chooseImage({count:5-o.length,sizeType:["compressed"],sourceType:["album"]})).tempFilePaths;for(let t=0;t<a.length;t++){let o=await e.index.compressImage({src:a[t],quality:80});a[t]=o.tempFilePath}t.memoryDetail.localPicPathList=o.concat(a)}}catch(o){}},inputMemoryContent(e){this.memoryDetail.content=e.target.value},onClickAddMemoryBack(){let t=this;e.index.showModal({title:"温馨提示",content:"返回会清空当前正记录的回忆哦",success:e=>{e.confirm&&(t.memoryDetail={},t.isShowAddMemory=!1,t.isShowPopup=!1)}})},onClickAddMemoryWrite(){let o=this;try{let a=o.memoryDetail;if(""===a.title)return void e.index.showToast({title:"回忆标题不能为空",icon:"none"});if(!0===c)return;c=!0,e.index.showModal({title:"温馨提示",content:"是否记录当前回忆",success:async i=>{if(i.confirm){let i=a.title+a.content;e.index.showLoading({title:"记录中...",mask:!0});let l=await t.commonFunctions.checkContentSecurity(i);0!==l.errCode?(e.index.hideLoading(),e.index.showModal({title:"温馨提示",content:l.errMsg,showCancel:!1,success:()=>{c=!1}})):await o.startWriteMemory()}i.cancel&&(c=!1)}})}catch(a){e.index.showModal({title:"温馨提示",content:"记录回忆失败请重试",showCancel:!1,success:e=>{e.confirm&&(c=!1)}})}},async startWriteMemory(){let t=this;try{await t.getCurrentAddressInfo(),await t.setMemoryIdAndDate(),await t.uploadLocalFileToCloud(),await t.uploadMemoryToCloud(),t.memoryDetail={},t.isShowAddMemory=!1,t.isShowPopup=!1,c=!1,e.index.hideLoading(),e.index.showToast({title:"记录成功",icon:"none"})}catch(o){e.index.hideLoading(),e.index.showModal({title:"温馨提示",content:"记录回忆失败，请重试",showCancel:!1,success:()=>{c=!1}})}},async getCurrentAddressInfo(){let e=this;try{let t=new Promise((t=>{wx.startLocationUpdate({success:()=>{wx.onLocationChange((async o=>{wx.offLocationChange(),wx.stopLocationUpdate(),await e.getCurrentLocation(o.latitude,o.longitude),t(!0)}))},fail:e=>{t(!0)}})}));await t}catch(t){}},async getCurrentLocation(e,t){let a=this;try{let i=new Promise((i=>{o.reverseGeocoder({location:{latitude:e,longitude:t},success:async e=>{if(e&&e.result){let t=e.result.address?e.result.address:"",o=e.result.ad_info.city?e.result.ad_info.city:"",i=e.result.ad_info.district?e.result.ad_info.district:"",l=i||o;await a.getCurrentWeather(l,t)}i(!0)},fail:()=>{i(!0)}})}));await i}catch(i){}},async getCurrentWeather(t,o){let a=this;try{let i=new Promise((i=>{e.index.request({url:"https://free-api.heweather.net/s6/weather/now",data:{location:t,key:"2ce65b27e7784d0f85ecd7b8127f5e2d"},success:e=>{let l=e.data.HeWeather6[0].now.cond_txt,r=e.data.HeWeather6[0].now.fl+"℃";a.memoryDetail.address=o+" "+l+" "+r,a.memoryDetail.simpleAddress=t+" "+l+" "+r,i(!0)},fail:()=>{i(!0)}})}));await i}catch(i){}},async setMemoryIdAndDate(){let e=this;try{let t=await a.getCurrentDate();0===t.errCode&&(e.memoryDetail.id=t.data.currentId,e.memoryDetail.date=t.data.currentDate)}catch(t){}},async uploadLocalFileToCloud(){let t=this;try{if(0===t.memoryDetail.localPicPathList.length)return;let o=t.memoryDetail.id,a=t.memoryDetail.localPicPathList,i=[];for(let l=0;l<a.length;l++)i.push(new Promise((i=>{e.rn.uploadFile({filePath:a[l],cloudPath:r.globalData.wx_openid+"."+o+l+".jpg"}).then((e=>{t.memoryDetail.cloudPicPathList[l]=e.fileID,i(!0)})).catch((e=>{t.memoryDetail.cloudPicPathList[l]="",i(!0)}))})));await Promise.all(i).then((()=>{})).catch((()=>{}))}catch(o){}},async uploadMemoryToCloud(){let t=this;try{await l.collection("memory").where("wx_openid == '"+r.globalData.wx_openid+"'").get().then((async o=>{if(0===o.result.errCode){let a=o.result.data[0]?o.result.data[0].memoryList:[];a.unshift(t.memoryDetail),0===o.result.data.length?await l.collection("memory").add({wx_openid:r.globalData.wx_openid,memoryList:a}).then((()=>{t.memoryList=a.slice(0,15),t.memorySum=a.length,e.index.setStorageSync(r.globalData.memoryCacheName,a.slice(0,15)),e.index.setStorageSync(r.globalData.memorySumCacheName,a.length)})).catch():await l.collection("memory").where("wx_openid == '"+r.globalData.wx_openid+"'").update({memoryList:a}).then((()=>{t.memoryList=a.slice(0,15),t.memorySum=a.length,e.index.setStorageSync(r.globalData.memoryCacheName,a.slice(0,15)),e.index.setStorageSync(r.globalData.memorySumCacheName,a.length)})).catch()}})).catch()}catch(o){}},deleteMemory(t){if(t)try{let o=this;e.index.showModal({title:"温馨提示",content:"是否删除回忆《"+t.title+"》",success:async a=>{if(a.confirm){e.index.showLoading({title:"删除中...",mask:!0});let a=await i.deleteMemory(r.globalData.wx_openid,t.id);0===a.errCode?(o.memoryList=a.data.memoryList.slice(0,15),o.memorySum=a.data.memoryList.length,e.index.setStorageSync(r.globalData.memoryCacheName,a.data.memoryList.slice(0,15)),e.index.setStorageSync(r.globalData.memorySumCacheName,a.data.memoryList.length),e.index.hideLoading(),e.index.showToast({title:"删除成功",icon:"none"})):(e.index.hideLoading(),e.index.showToast({title:"删除失败",icon:"none"}))}}})}catch(o){}}}};var m=e._export_sfc(n,[["render",function(t,o,a,i,l,r){return e.e({a:"overflow:"+(l.isShowPopup?"hidden":"visible"),b:e.t(l.notice),c:e.t(l.memorySum),d:l.memorySum>0},l.memorySum>0?{e:e.f(l.memoryList,((t,o,a)=>e.e({a:e.t(t.title),b:e.t(t.content),c:t.cloudPicPathList.length>0},t.cloudPicPathList.length>0?{d:e.f(t.cloudPicPathList,((t,o,a)=>({a:t||"../../static/img_empty_icon.png",b:e.s("margin-left:"+(0===o?"0rpx":"5rpx")),c:o})))}:{},{e:e.t(t.date+"    "+t.simpleAddress),f:e.o((e=>r.onClickEditorMemory(t))),g:e.s("margin-top:"+(0===o?"-70rpx":"20rpx")),h:e.o((e=>r.onClickMemoryCell(t))),i:o})))}:{},{f:e.o(((...e)=>r.onClickAddMemory&&r.onClickAddMemory(...e))),g:!0===l.isShowMemoryDetail},!0===l.isShowMemoryDetail?e.e({h:e.o(((...e)=>r.onClickMemoryDetailMask&&r.onClickMemoryDetailMask(...e))),i:e.t(l.memoryDetail.title),j:l.memoryDetail.cloudPicPathList.length>0},l.memoryDetail.cloudPicPathList.length>0?{k:e.f(l.memoryDetail.cloudPicPathList,((t,o,a)=>({a:t||"../../static/img_empty_icon.png",b:e.o((e=>r.onPreviewMemoryCellPic("cloud",o))),c:e.s("margin-left:"+((o+1)%5==1?"0rpx":"10rpx")+";margin-top:"+(o>4?"5rpx":"0rpx")),d:o})))}:{},{l:l.memoryDetail.content},l.memoryDetail.content?{m:e.t(l.memoryDetail.content)}:{},{n:l.memoryDetail.date},l.memoryDetail.date?{o:e.t(l.memoryDetail.date)}:{},{p:l.memoryDetail.address&&" "!==l.memoryDetail.address},l.memoryDetail.address&&" "!==l.memoryDetail.address?{q:e.t(l.memoryDetail.address)}:{}):{},{r:!0===l.isShowAddMemory},!0===l.isShowAddMemory?e.e({s:e.o(((...e)=>r.inputMemoryTitle&&r.inputMemoryTitle(...e))),t:l.memoryDetail.localPicPathList.length>0},l.memoryDetail.localPicPathList.length>0?{v:e.f(l.memoryDetail.localPicPathList,((t,o,a)=>({a:t||"../../static/img_empty_icon.png",b:e.o((e=>r.onPreviewMemoryCellPic("local",o))),c:e.o((e=>r.onClickDeletePic(o))),d:e.s("margin-left:"+((o+1)%5==1?"0rpx":"10rpx")+";margin-top:"+(o>4?"5rpx":"0rpx")),e:o})))}:{},{w:l.memoryDetail.localPicPathList.length<5},l.memoryDetail.localPicPathList.length<5?{x:e.s("margin-left:"+(l.memoryDetail.localPicPathList.length>0?"10rpx":"0rpx")+";"),y:e.o(((...e)=>r.onClickAddPic&&r.onClickAddPic(...e)))}:{},{z:e.o(((...e)=>r.inputMemoryContent&&r.inputMemoryContent(...e))),A:e.o(((...e)=>r.onClickAddMemoryBack&&r.onClickAddMemoryBack(...e))),B:e.o(((...e)=>r.onClickAddMemoryWrite&&r.onClickAddMemoryWrite(...e)))}):{})}]]);n.__runtimeHooks=2,wx.createPage(m);
