"use strict";var e=require("../../common/vendor.js"),t=require("../../common/commonFunctions.js");const o=new(require("../../common/qqmap-wx-jssdk.js").QQMapWX)({key:"3XKBZ-WP4CG-KQVQM-IJ2WK-7QAE7-2ZFKZ"}),a=e.pn.importObject("serverDate",{customUI:!0}),i=e.pn.importObject("handleMemory",{customUI:!0}),r=e.pn.database(),l=getApp();var c=!1;const n={data:()=>({notice:e.index.getStorageSync(l.globalData.noticeCacheName)?e.index.getStorageSync(l.globalData.noticeCacheName):"",memorySum:e.index.getStorageSync(l.globalData.memorySumCacheName)?e.index.getStorageSync(l.globalData.memorySumCacheName):0,memoryList:e.index.getStorageSync(l.globalData.memoryCacheName)?e.index.getStorageSync(l.globalData.memoryCacheName):[],isShowPopup:!1,memoryDetail:void 0,isShowMemoryDetail:!1,isShowAddMemory:!1,searchMemory:""}),async onLoad(){let o=this;e.index.showLoading({title:"载入回忆中",mask:!0}),l.globalData.wx_openid||await t.commonFunctions.wxLogin(),o.uploadAccessToCloud(l.globalData.wx_openid),o.getNoticeFromCloud(),await o.getMemoryFromCloud(l.globalData.wx_openid,0),e.index.hideLoading()},async onPullDownRefresh(){let t=this;try{e.index.showLoading({title:"更新回忆中",mask:!0}),t.getNoticeFromCloud(),await t.getMemoryFromCloud(l.globalData.wx_openid,0),e.index.stopPullDownRefresh(),e.index.hideLoading()}catch(o){}},async onReachBottom(){let t=this;try{let o=t.memoryList.length;if(t.searchMemory)return;o===t.memorySum?e.index.showToast({title:"回忆到底啦",icon:"none"}):(e.index.showLoading({title:"载入回忆中",mask:!0}),await t.getMemoryFromCloud(l.globalData.wx_openid,o),e.index.hideLoading())}catch(o){}},onShareAppMessage:()=>({title:"记录关于你的回忆",path:"/pages/memory/memory",imageUrl:"https://vkceyugu.cdn.bspapp.com/VKCEYUGU-bcf64df9-4d03-4023-bc85-9000afa0f691/e989c0a9-706c-4c3c-8020-3c04a0e2344d.png"}),methods:{async uploadAccessToCloud(e){if(e)try{await r.collection("access").where("wx_openid == '"+e+"'").get().then((async t=>{if(0===t.result.errCode){let o=t.result.data[0]?t.result.data[0].accessList:[],i=await a.getCurrentDate();o.slice(0,99),o.unshift(i.data.currentDate),0===t.result.data.length?await r.collection("access").add({wx_openid:e,accessList:o}).then().catch():await r.collection("access").where("wx_openid == '"+e+"'").update({accessList:o})}})).catch()}catch(t){}},async getNoticeFromCloud(){let t=this;try{await r.collection("notice").where("_id == '62f49bb51ff3ac000168404b'").get().then((o=>{if(0===o.result.errCode){let a=o.result.data[0].noticeList[0].notice;a!==e.index.getStorageSync(l.globalData.noticeCacheName)&&(t.notice=a,e.index.setStorageSync(l.globalData.noticeCacheName,a))}})).catch()}catch(o){}},async getMemoryFromCloud(t,o){let a=this;try{await r.collection("memory").where("wx_openid == '"+t+"'").get().then((t=>{if(0===t.result.errCode){let i=t.result.data[0]?t.result.data[0].memoryList:[],r=i.slice(o,o+15),c=i.length;0===o?(a.memoryList=r,a.memorySum=c,e.index.setStorageSync(l.globalData.memoryCacheName,r),e.index.setStorageSync(l.globalData.memorySumCacheName,c)):a.memoryList=a.memoryList.concat(r),a.searchMemory=""}})).catch()}catch(i){}},onClickMemoryCell(e){let t=this;t.isShowPopup=!0,t.memoryDetail=e,t.isShowMemoryDetail=!0},onClickEditorMemory(t){let o=this;try{e.index.showActionSheet({itemList:["删除该回忆"],success:e=>{0===e.tapIndex&&o.deleteMemory(t)},fail:()=>{}})}catch(a){}},onClickAddMemory(){let e=this;e.isShowPopup=!0,e.memoryDetail={id:0,title:"",content:"",localPicPathList:[],cloudPicPathList:[],address:"",simpleAddress:"",date:""},e.isShowAddMemory=!0},onClickMemoryDetailMask(){let e=this;e.isShowMemoryDetail=!1,e.isShowPopup=!1,e.memoryDetail=void 0},onPreviewMemoryCellPic(t,o){let a=this;try{let i="cloud"===t?a.memoryDetail.cloudPicPathList:a.memoryDetail.localPicPathList,r=i&&i[o]?i[o]:"",l=[];if(!r)return;for(let e=0;e<i.length;e++)i[e]&&l.push(i[e]);e.index.previewImage({current:r,urls:l})}catch(i){}},inputMemoryTitle(e){this.memoryDetail.title=e.target.value},onClickDeletePic(e){this.memoryDetail.localPicPathList.splice(e,1)},chooseImage:t=>new Promise((o=>{e.index.chooseImage({count:t,sizeType:["compressed"],sourceType:["album"],success:e=>{o(e)},fail:()=>{o(void 0)}})})),compressImage:t=>new Promise((o=>{e.index.compressImage({src:t,quality:80,success:e=>{o(e.tempFilePath)},fail:()=>{o(t)}})})),async onClickAddPic(){let t=this;try{let o=t.memoryDetail.localPicPathList;if(o.length>=5)e.index.showToast({title:"图片最多记录5张",icon:"none"});else{let a=await t.chooseImage(5-o.length);if(!a)return;e.index.showLoading({title:"图片选择中...",mask:!0});let i=a.tempFiles;i=await t.compressImgList(a.tempFiles);for(let e=0;e<i.length;e++){let o=await t.compressImage(i[e]);i[e]=o}t.memoryDetail.localPicPathList=o.concat(i),e.index.hideLoading()}}catch(o){}},getImageInfo:t=>new Promise((o=>{e.index.getImageInfo({src:t,success:e=>{o(e)},fail:()=>{o(void 0)}})})),async compressImgList(t){let o=this;try{let a=[];for(let i=0;i<t.length;i++){if(t[i].size/1024<500){a.push(t[i].path);continue}let r=await o.getImageInfo(t[i].path);if(!r)continue;let l=new Promise((t=>{e.index.createSelectorQuery().select("#myCanvas").fields({node:!0,size:!0}).exec((e=>{const o=e[0].node,i=o.getContext("2d"),l=r.height/r.width;o.width=r.width>750?750:r.width,o.height=o.width*l;let c=o.createImage();c.src=r.path,c.onload=()=>{i.drawImage(c,0,0,o.width,o.height),wx.canvasToTempFilePath({canvas:o,fileType:"jpg",success:e=>{a.push(e.tempFilePath),t(!0)},fail:()=>{t(!0)}},this)},c.onerror=()=>{t(!0)}}))}));await l}return a}catch(a){}},inputMemoryContent(e){this.memoryDetail.content=e.target.value},onClickAddMemoryBack(){let t=this;e.index.showModal({title:"温馨提示",content:"返回会清空当前正记录的回忆哦",success:e=>{e.confirm&&(t.memoryDetail=void 0,t.isShowAddMemory=!1,t.isShowPopup=!1)}})},onClickAddMemoryWrite(){let o=this;try{let a=o.memoryDetail;if(""===a.title)return void e.index.showToast({title:"回忆标题不能为空",icon:"none"});if(!0===c)return;c=!0,e.index.showModal({title:"温馨提示",content:"是否记录当前回忆",success:async i=>{if(i.confirm){let i=a.title+a.content;e.index.showLoading({title:"记录中...",mask:!0});let r=await t.commonFunctions.checkContentSecurity(i);0!==r.errCode?(e.index.hideLoading(),e.index.showModal({title:"温馨提示",content:r.errMsg,showCancel:!1,success:()=>{c=!1}})):await o.startWriteMemory()}i.cancel&&(c=!1)}})}catch(a){e.index.showModal({title:"温馨提示",content:"记录回忆失败请重试",showCancel:!1,success:e=>{e.confirm&&(c=!1)}})}},async startWriteMemory(){let t=this;try{await t.getCurrentAddressInfo(),await t.setMemoryIdAndDate(),await t.uploadLocalFileToCloud(),await t.uploadMemoryToCloud(),t.memoryDetail=void 0,t.isShowAddMemory=!1,t.isShowPopup=!1,c=!1,e.index.hideLoading(),e.index.showToast({title:"记录成功",icon:"none"})}catch(o){e.index.hideLoading(),e.index.showModal({title:"温馨提示",content:"记录回忆失败，请重试",showCancel:!1,success:()=>{c=!1}})}},async getCurrentAddressInfo(){let e=this;try{let t=new Promise((t=>{wx.startLocationUpdate({success:()=>{wx.onLocationChange((async o=>{wx.offLocationChange(),wx.stopLocationUpdate(),await e.getCurrentLocation(o.latitude,o.longitude),t(!0)}))},fail:()=>{t(!0)}})}));await t}catch(t){}},async getCurrentLocation(e,t){let a=this;try{let i=new Promise((i=>{o.reverseGeocoder({location:{latitude:e,longitude:t},success:async e=>{if(e&&e.result){let t=e.result.address?e.result.address:"",o=e.result.ad_info.city?e.result.ad_info.city:"",i=e.result.ad_info.district?e.result.ad_info.district:"",r=i||o;await a.getCurrentWeather(r,t)}i(!0)},fail:()=>{i(!0)}})}));await i}catch(i){}},async getCurrentWeather(t,o){let a=this;try{let i=new Promise((i=>{e.index.request({url:"https://free-api.heweather.net/s6/weather/now",data:{location:t,key:"2ce65b27e7784d0f85ecd7b8127f5e2d"},success:e=>{let r=e.data.HeWeather6[0].now.cond_txt,l=e.data.HeWeather6[0].now.fl+"℃";a.memoryDetail.address=o+" "+r+" "+l,a.memoryDetail.simpleAddress=t+" "+r+" "+l,i(!0)},fail:()=>{i(!0)}})}));await i}catch(i){}},async setMemoryIdAndDate(){let e=this;try{let t=await a.getCurrentDate();0===t.errCode&&(e.memoryDetail.id=t.data.currentId,e.memoryDetail.date=t.data.currentDate)}catch(t){}},async uploadLocalFileToCloud(){let t=this;try{if(0===t.memoryDetail.localPicPathList.length)return;let o=t.memoryDetail.id,a=t.memoryDetail.localPicPathList,i=[];for(let r=0;r<a.length;r++)i.push(new Promise((i=>{e.pn.uploadFile({filePath:a[r],cloudPath:l.globalData.wx_openid+"."+o+r+".jpg"}).then((e=>{t.memoryDetail.cloudPicPathList[r]=e.fileID,i(!0)})).catch((()=>{t.memoryDetail.cloudPicPathList[r]="",i(!0)}))})));await Promise.all(i).then((()=>{})).catch((()=>{}))}catch(o){}},async uploadMemoryToCloud(){let t=this;try{await r.collection("memory").where("wx_openid == '"+l.globalData.wx_openid+"'").get().then((async o=>{if(0===o.result.errCode){let a=o.result.data[0]?o.result.data[0].memoryList:[];a.unshift(t.memoryDetail),0===o.result.data.length?await r.collection("memory").add({wx_openid:l.globalData.wx_openid,memoryList:a}).then((()=>{t.memoryList=a.slice(0,15),t.memorySum=a.length,t.searchMemory="",e.index.setStorageSync(l.globalData.memoryCacheName,a.slice(0,15)),e.index.setStorageSync(l.globalData.memorySumCacheName,a.length)})).catch():await r.collection("memory").where("wx_openid == '"+l.globalData.wx_openid+"'").update({memoryList:a}).then((()=>{t.memoryList=a.slice(0,15),t.memorySum=a.length,t.searchMemory="",e.index.setStorageSync(l.globalData.memoryCacheName,a.slice(0,15)),e.index.setStorageSync(l.globalData.memorySumCacheName,a.length)})).catch()}})).catch()}catch(o){}},deleteMemory(t){if(t)try{let o=this;e.index.showModal({title:"温馨提示",content:"是否删除回忆《"+t.title+"》",success:async a=>{if(a.confirm){e.index.showLoading({title:"删除中...",mask:!0});let a=await i.deleteMemory(l.globalData.wx_openid,t.id);0===a.errCode?(o.memoryList=a.data.memoryList.slice(0,15),o.searchMemory="",o.memorySum=a.data.memoryList.length,e.index.setStorageSync(l.globalData.memoryCacheName,a.data.memoryList.slice(0,15)),e.index.setStorageSync(l.globalData.memorySumCacheName,a.data.memoryList.length),e.index.hideLoading(),e.index.showToast({title:"删除成功",icon:"none"})):(e.index.hideLoading(),e.index.showToast({title:"删除失败",icon:"none"}))}}})}catch(o){}},inputSearchMemory(e){this.searchMemory=e.target.value},async onClickSearchMemory(){let t=this;try{let o=[];if(!t.searchMemory)return void(t.memoryList=e.index.getStorageSync(l.globalData.memoryCacheName)?e.index.getStorageSync(l.globalData.memoryCacheName):[]);e.index.showLoading({title:"搜索回忆中",mask:!0}),await r.collection("memory").where("wx_openid == '"+l.globalData.wx_openid+"'").get().then((async e=>{if(0===e.result.errCode){let a=e.result.data[0]?e.result.data[0].memoryList:[];for(let e=0;e<a.length;e++)-1===a[e].title.indexOf(t.searchMemory)&&-1===a[e].content.indexOf(t.searchMemory)||o.push(a[e]);t.memoryList=o}})).catch(),e.index.hideLoading()}catch(o){}}}};var s=e._export_sfc(n,[["render",function(t,o,a,i,r,l){return e.e({a:"overflow:"+(r.isShowPopup?"hidden":"visible"),b:e.t(r.notice),c:e.t(r.memorySum),d:r.searchMemory,e:e.o(((...e)=>l.inputSearchMemory&&l.inputSearchMemory(...e))),f:e.o(((...e)=>l.onClickSearchMemory&&l.onClickSearchMemory(...e))),g:r.memorySum>0},r.memorySum>0?{h:e.f(r.memoryList,((t,o,a)=>e.e({a:e.t(t.title),b:e.t(t.content),c:t.cloudPicPathList.length>0},t.cloudPicPathList.length>0?{d:e.f(t.cloudPicPathList,((t,o,a)=>({a:t||"../../static/img_empty_icon.png",b:e.s("margin-left:"+(0===o?"0rpx":"5rpx")),c:o})))}:{},{e:e.t(t.date+"    "+t.simpleAddress),f:e.o((e=>l.onClickEditorMemory(t))),g:e.s("margin-top:"+(0===o?"-70rpx":"20rpx")),h:e.o((e=>l.onClickMemoryCell(t))),i:o})))}:{},{i:e.o(((...e)=>l.onClickAddMemory&&l.onClickAddMemory(...e))),j:!0===r.isShowMemoryDetail},!0===r.isShowMemoryDetail?e.e({k:e.o(((...e)=>l.onClickMemoryDetailMask&&l.onClickMemoryDetailMask(...e))),l:e.t(r.memoryDetail.title),m:r.memoryDetail.cloudPicPathList.length>0},r.memoryDetail.cloudPicPathList.length>0?{n:e.f(r.memoryDetail.cloudPicPathList,((t,o,a)=>({a:t||"../../static/img_empty_icon.png",b:e.o((e=>l.onPreviewMemoryCellPic("cloud",o))),c:e.s("margin-left:"+((o+1)%5==1?"0rpx":"10rpx")+";margin-top:"+(o>4?"5rpx":"0rpx")),d:o})))}:{},{o:r.memoryDetail.content},r.memoryDetail.content?{p:e.t(r.memoryDetail.content)}:{},{q:r.memoryDetail.date},r.memoryDetail.date?{r:e.t(r.memoryDetail.date)}:{},{s:r.memoryDetail.address&&" "!==r.memoryDetail.address},r.memoryDetail.address&&" "!==r.memoryDetail.address?{t:e.t(r.memoryDetail.address)}:{}):{},{v:!0===r.isShowAddMemory},!0===r.isShowAddMemory?e.e({w:e.o(((...e)=>l.inputMemoryTitle&&l.inputMemoryTitle(...e))),x:r.memoryDetail.localPicPathList.length>0},r.memoryDetail.localPicPathList.length>0?{y:e.f(r.memoryDetail.localPicPathList,((t,o,a)=>({a:t||"../../static/img_empty_icon.png",b:e.o((e=>l.onPreviewMemoryCellPic("local",o))),c:e.o((e=>l.onClickDeletePic(o))),d:e.s("margin-left:"+((o+1)%5==1?"0rpx":"10rpx")+";margin-top:"+(o>4?"5rpx":"0rpx")),e:o})))}:{},{z:r.memoryDetail.localPicPathList.length<5},r.memoryDetail.localPicPathList.length<5?{A:e.s("margin-left:"+(r.memoryDetail.localPicPathList.length>0?"10rpx":"0rpx")+";"),B:e.o(((...e)=>l.onClickAddPic&&l.onClickAddPic(...e)))}:{},{C:e.o(((...e)=>l.inputMemoryContent&&l.inputMemoryContent(...e))),D:e.o(((...e)=>l.onClickAddMemoryBack&&l.onClickAddMemoryBack(...e))),E:e.o(((...e)=>l.onClickAddMemoryWrite&&l.onClickAddMemoryWrite(...e)))}):{})}]]);n.__runtimeHooks=2,wx.createPage(s);
