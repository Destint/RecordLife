"use strict";var e=require("../../common/vendor.js"),a=require("../../common/commonFunctions.js");const t=getApp(),i=e.rn.database(),n=e.rn.importObject("serverDate",{customUI:!0}),o=e.rn.importObject("handleCloudStorage",{customUI:!0}),c={data:()=>({isShowPopup:!1,cloudAvatarPath:e.index.getStorageSync(t.globalData.cloudAvatarPathCacheName)?e.index.getStorageSync(t.globalData.cloudAvatarPathCacheName):"",nickname:e.index.getStorageSync(t.globalData.nicknameCacheName)?e.index.getStorageSync(t.globalData.nicknameCacheName):"请设置昵称",calendar:e.index.getStorageSync(t.globalData.calendarCacheName)?e.index.getStorageSync(t.globalData.calendarCacheName):{},role:e.index.getStorageSync(t.globalData.roleCacheName)?e.index.getStorageSync(t.globalData.roleCacheName):"ordinary",isShowSetNicknameView:!1,setNicknameContent:"",isShowSetNoticeView:!1,setNoticeContent:"",isShowOtherFunctionView:!1,otherFunctionTitle:"",otherFunctionContent:"",isShowAboutApp:!1,aboutAppContent:"这是一个可以《留住回忆》的小程序。\n可选的需要小程序授权的功能：\n1、开启定位后，可在记录回忆时记下位置与天气。\n2、可从相册中选择想要的图片一同记录。\n如果您在使用小程序时遇到任何问题或者您对小程序有更好的建议或想法，欢迎通过《联系客服》功能来向开发者反馈。",isPraiseApp:!!e.index.getStorageSync(t.globalData.isPraiseAppCacheName)&&e.index.getStorageSync(t.globalData.isPraiseAppCacheName),praiseAppSum:e.index.getStorageSync(t.globalData.praiseAppSumCacheName)?e.index.getStorageSync(t.globalData.praiseAppSumCacheName):0}),async onLoad(){e.index.showLoading({title:"加载中",mask:!0}),t.globalData.wx_openid||await a.commonFunctions.wxLogin(),await this.getUserInfoFromCloud(t.globalData.wx_openid),await this.getCalendarInfo(),e.index.hideLoading()},onShareAppMessage:()=>({title:"记录关于你的回忆",path:"/pages/memory/memory",imageUrl:"https://vkceyugu.cdn.bspapp.com/VKCEYUGU-bcf64df9-4d03-4023-bc85-9000afa0f691/e989c0a9-706c-4c3c-8020-3c04a0e2344d.png"}),methods:{async getUserInfoFromCloud(a){let n=this;try{await i.collection("user").where("wx_openid == '"+a+"'").get().then((a=>{if(0===a.result.errCode){let i=a.result.data[0];n.cloudAvatarPath=i.avatar?i.avatar:"",n.nickname=i.nickname?i.nickname:"请设置昵称",n.role=i.role?i.role:"ordinary",e.index.setStorageSync(t.globalData.cloudAvatarPathCacheName,i.avatar),e.index.setStorageSync(t.globalData.nicknameCacheName,i.nickname),e.index.setStorageSync(t.globalData.roleCacheName,i.role)}})).catch()}catch(o){}},async getCalendarInfo(){let a=this;try{let i=(await n.getCurrentDate()).data.currentDate.slice(0,10),o=e.index.getStorageSync(t.globalData.calendarCacheName);if(o&&o.date===i)return;let c=(await e.index.request({url:"https://api.djapi.cn/wannianli/get",data:{date:i,cn_to_unicode:"1",token:"37555a616248cb486ca0e60c10eca164",datatype:"json"}})).data.Result,l={};l.date=i,l.year=c.nianci.slice(0,3),l.month=c.nianci.slice(3,6),l.day=c.nianci.slice(6,9),l.zodiac=c.shengxiao,l.lunar=c.nongli.slice(3,7),l.solarTerm=c.jieqi,l.suitable=c.do,l.tapu=c.nodo,a.calendar=l,e.index.setStorageSync(t.globalData.calendarCacheName,l)}catch(i){}},async onClickSetAvatar(){let a=this;try{let n=await e.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album"]});e.index.showLoading({title:"设置中...",mask:!0});let c=n.tempFilePaths,l=await e.index.compressImage({src:c[0],quality:80});c[0]=l.tempFilePath,await e.rn.uploadFile({filePath:c[0],cloudPath:t.globalData.wx_openid+".avatar.jpg"}).then((async n=>{let c=n.fileID;a.cloudAvatarPath=c,e.index.setStorageSync(t.globalData.cloudAvatarPathCacheName,c),await i.collection("user").where("wx_openid == '"+t.globalData.wx_openid+"'").get().then((async e=>{if(0===e.result.errCode){let a=e.result.data[0]?e.result.data[0].avatar:"",t=[];a&&(t.push(a),await o.deleteCloudFiles(t))}})).catch(),await i.collection("user").where("wx_openid == '"+t.globalData.wx_openid+"'").update({avatar:c}).then().catch()})).catch(),e.index.hideLoading()}catch(n){e.index.hideLoading()}},onClickSetNickname(){let e=this;e.isShowPopup=!0,e.isShowSetNicknameView=!0,e.setNicknameContent=""},onClickSetNicknameMask(){let e=this;e.setNicknameContent="",e.isShowSetNicknameView=!1,e.isShowPopup=!1},inputNicknameContent(e){this.setNicknameContent=e.target.value},async onClickUploadNickname(){let a=this;try{let n=a.setNicknameContent;if(!n)return void e.index.showToast({title:"昵称不能为空",icon:"none"});e.index.showModal({title:"温馨提示",content:"是否设置该昵称",success:async o=>{o.confirm&&(e.index.showLoading({title:"设置中...",mask:!0}),await i.collection("user").where("wx_openid == '"+t.globalData.wx_openid+"'").update({nickname:n}).then((i=>{a.nickname=n,e.index.setStorageSync(t.globalData.nicknameCacheName,n),a.onClickSetNicknameMask(),e.index.hideLoading(),e.index.showToast({title:"设置成功",icon:"none"})})).catch((t=>{a.onClickSetNicknameMask(),e.index.hideLoading()})))}})}catch(n){a.onClickSetNicknameMask(),e.index.hideLoading()}},onClickSetNotice(){let e=this;e.isShowPopup=!0,e.isShowSetNoticeView=!0,e.setNoticeContent=""},onClickSetNoticeMask(){let e=this;e.setNoticeContent="",e.isShowSetNoticeView=!1,e.isShowPopup=!1},inputNoticeContent(e){this.setNoticeContent=e.target.value},async onClickUploadNotice(){let a=this;try{let t=a.setNoticeContent;if(!t)return void e.index.showToast({title:"公告不能为空",icon:"none"});e.index.showModal({title:"温馨提示",content:"是否设置该公告",success:async o=>{o.confirm&&(e.index.showLoading({title:"设置中...",mask:!0}),await i.collection("notice").where("_id == '62f49bb51ff3ac000168404b'").get().then((async o=>{if(0===o.result.errCode){let c=o.result.data[0]?o.result.data[0].noticeList:[],l=(await n.getCurrentDate()).data.currentDate,s={};s.notice=t,s.date=l,c.unshift(s),await i.collection("notice").where("_id == '62f49bb51ff3ac000168404b'").update({noticeList:c}).then((t=>{a.onClickSetNoticeMask(),e.index.hideLoading(),e.index.showToast({title:"设置成功",icon:"none"})})).catch((t=>{a.onClickSetNoticeMask(),e.index.hideLoading()}))}})).catch((t=>{a.onClickSetNoticeMask(),e.index.hideLoading()})))}})}catch(t){a.onClickSetNoticeMask(),e.index.hideLoading()}},onClickSuitAndAvoid(){let e=this;e.otherFunctionTitle="今日宜忌",e.otherFunctionContent="宜: "+e.calendar.suitable+"\n忌: "+e.calendar.tapu,e.isShowPopup=!0,e.isShowOtherFunctionView=!0},onClickOtherFunctionMask(){let e=this;e.isShowOtherFunctionView=!1,e.isShowPopup=!1,e.otherFunctionTitle="",e.otherFunctionContent=""},async onClickRandomJoke(){let a=this;try{e.index.showLoading({title:"生成中...",mask:!0});let t=await e.index.request({url:"https://api.vvhan.com/api/joke?type=json"});if(t&&t.data&&t.data.success){let e=t.data.joke,i=t.data.title;a.otherFunctionTitle=i,a.otherFunctionContent=e,a.isShowPopup=!0,a.isShowOtherFunctionView=!0}e.index.hideLoading()}catch(t){e.index.hideLoading()}},async onClickRandomSweetWorld(){let a=this;try{e.index.showLoading({title:"生成中...",mask:!0});let t=await e.index.request({url:"https://api.vvhan.com/api/love?type=json"});t&&t.data&&t.data.success&&(a.otherFunctionTitle="随机情话",a.otherFunctionContent=t.data.ishan,a.isShowPopup=!0,a.isShowOtherFunctionView=!0),e.index.hideLoading()}catch(t){e.index.hideLoading()}},async onClickAboutApp(){let e=this;try{e.getPraiseInfoFromCloud(),e.isShowPopup=!0,e.isShowAboutApp=!0}catch(a){}},onClickAboutAppMask(){this.isShowAboutApp=!1,this.isShowPopup=!1},async getPraiseInfoFromCloud(){let a=this;try{await i.collection("praise").where("_id == '6310654ce3e39a0001adc296'").get().then((i=>{if(0===i.result.errCode){let n=i.result.data[0]?i.result.data[0].praiseList:[];a.isPraiseApp=-1!==n.indexOf(t.globalData.wx_openid),a.praiseAppSum=n.length,e.index.setStorageSync(t.globalData.isPraiseAppCacheName,a.isPraiseApp),e.index.setStorageSync(t.globalData.praiseAppSumCacheName,a.praiseAppSum)}})).catch()}catch(n){}},async onClickPraiseApp(){let a=this;try{if(!0===a.isPraiseApp)return;await i.collection("praise").where("_id == '6310654ce3e39a0001adc296'").get().then((async n=>{if(0===n.result.errCode){let o=n.result.data[0]?n.result.data[0].praiseList:[];-1===o.indexOf(t.globalData.wx_openid)&&o.unshift(t.globalData.wx_openid),a.isPraiseApp=-1!==o.indexOf(t.globalData.wx_openid),a.praiseAppSum=o.length,e.index.setStorageSync(t.globalData.isPraiseAppCacheName,a.isPraiseApp),e.index.setStorageSync(t.globalData.praiseAppSumCacheName,a.praiseAppSum),e.index.showToast({title:"谢谢你，陌生人",icon:"none"}),await i.collection("praise").where("_id == '6310654ce3e39a0001adc296'").update({praiseList:o}).then().catch()}})).catch()}catch(n){}},async onClickFishCalendar(){try{e.index.showLoading({title:"生成中...",mask:!0});let a=await e.index.request({url:"https://api.vvhan.com/api/moyu?type=json"});if(e.index.hideLoading(),a&&a.data&&a.data.url){let t=[];t.push(a.data.url),e.index.previewImage({current:a.data.url,urls:t,indicator:"none"})}}catch(a){e.index.hideLoading()}}}};var l=e._export_sfc(c,[["render",function(a,t,i,n,o,c){return e.e({a:"overflow:"+(o.isShowPopup?"hidden":"visible"),b:o.cloudAvatarPath?o.cloudAvatarPath:"../../static/img_default_avatar_icon.png",c:e.t(o.nickname),d:o.calendar.date},o.calendar.date?{e:e.t(o.calendar.date),f:e.t(o.calendar.lunar),g:e.t(o.calendar.year+" "+o.calendar.zodiac),h:e.t(o.calendar.month+" "+o.calendar.day),i:e.t(o.calendar.solarTerm)}:{},{j:e.o(((...e)=>c.onClickSetAvatar&&c.onClickSetAvatar(...e))),k:e.o(((...e)=>c.onClickSetNickname&&c.onClickSetNickname(...e))),l:"manager"===o.role},"manager"===o.role?{m:e.o(((...e)=>c.onClickSetNotice&&c.onClickSetNotice(...e)))}:{},{n:e.o(((...e)=>c.onClickSuitAndAvoid&&c.onClickSuitAndAvoid(...e))),o:e.o(((...e)=>c.onClickRandomJoke&&c.onClickRandomJoke(...e))),p:e.o(((...e)=>c.onClickRandomSweetWorld&&c.onClickRandomSweetWorld(...e))),q:e.o(((...e)=>c.onClickFishCalendar&&c.onClickFishCalendar(...e))),r:e.o(((...e)=>c.onClickAboutApp&&c.onClickAboutApp(...e))),s:!0===o.isShowSetNicknameView},!0===o.isShowSetNicknameView?{t:e.o(((...e)=>c.onClickSetNicknameMask&&c.onClickSetNicknameMask(...e))),v:e.o(((...e)=>c.inputNicknameContent&&c.inputNicknameContent(...e))),w:e.o(((...e)=>c.onClickUploadNickname&&c.onClickUploadNickname(...e)))}:{},{x:!0===o.isShowSetNoticeView},!0===o.isShowSetNoticeView?{y:e.o(((...e)=>c.onClickSetNoticeMask&&c.onClickSetNoticeMask(...e))),z:e.o(((...e)=>c.inputNoticeContent&&c.inputNoticeContent(...e))),A:e.o(((...e)=>c.onClickUploadNotice&&c.onClickUploadNotice(...e)))}:{},{B:!0===o.isShowOtherFunctionView},!0===o.isShowOtherFunctionView?{C:e.o(((...e)=>c.onClickOtherFunctionMask&&c.onClickOtherFunctionMask(...e))),D:e.t(o.otherFunctionTitle),E:e.t(o.otherFunctionContent)}:{},{F:!0===o.isShowAboutApp},!0===o.isShowAboutApp?{G:e.o(((...e)=>c.onClickAboutAppMask&&c.onClickAboutAppMask(...e))),H:e.t(o.aboutAppContent),I:e.o(((...e)=>c.onClickPraiseApp&&c.onClickPraiseApp(...e))),J:o.isPraiseApp?"../../static/img_praise_icon.png":"../../static/img_no_praise_icon.png",K:e.t(o.praiseAppSum)}:{})}]]);c.__runtimeHooks=2,wx.createPage(l);
