"use strict";var e=require("../../common/vendor.js"),t=require("../../common/commonFunctions.js");const a=getApp(),i=e.pn.database(),n=e.pn.importObject("serverDate",{customUI:!0}),o=e.pn.importObject("handleCloudStorage",{customUI:!0}),c={data:()=>({isShowPopup:!1,cloudAvatarPath:e.index.getStorageSync(a.globalData.cloudAvatarPathCacheName)?e.index.getStorageSync(a.globalData.cloudAvatarPathCacheName):"",nickname:e.index.getStorageSync(a.globalData.nicknameCacheName)?e.index.getStorageSync(a.globalData.nicknameCacheName):"请设置昵称",calendar:e.index.getStorageSync(a.globalData.calendarCacheName)?e.index.getStorageSync(a.globalData.calendarCacheName):{},role:e.index.getStorageSync(a.globalData.roleCacheName)?e.index.getStorageSync(a.globalData.roleCacheName):"ordinary",isShowSetNicknameView:!1,setNicknameContent:"",isShowSetNoticeView:!1,setNoticeContent:"",isShowOtherFunctionView:!1,otherFunctionTitle:"",otherFunctionContent:"",isShowAboutApp:!1,aboutAppContent:"这是一个可以《留住回忆》的小程序。\n可选的需要小程序授权的功能：\n1、开启定位后，可在记录回忆时记下位置与天气。\n2、可从相册中选择想要的图片一同记录。\n如果您在使用小程序时遇到任何问题或者您对小程序有更好的建议或想法，欢迎通过《联系客服》功能来向开发者反馈。",isPraiseApp:!!e.index.getStorageSync(a.globalData.isPraiseAppCacheName)&&e.index.getStorageSync(a.globalData.isPraiseAppCacheName),praiseAppSum:e.index.getStorageSync(a.globalData.praiseAppSumCacheName)?e.index.getStorageSync(a.globalData.praiseAppSumCacheName):0}),async onLoad(){e.index.showLoading({title:"加载中",mask:!0}),a.globalData.wx_openid||await t.commonFunctions.wxLogin(),await this.getUserInfoFromCloud(a.globalData.wx_openid),await this.getCalendarInfo(),e.index.hideLoading()},onShareAppMessage:()=>({title:"记录关于你的回忆",path:"/pages/memory/memory",imageUrl:"https://vkceyugu.cdn.bspapp.com/VKCEYUGU-bcf64df9-4d03-4023-bc85-9000afa0f691/e989c0a9-706c-4c3c-8020-3c04a0e2344d.png"}),methods:{async getUserInfoFromCloud(t){let n=this;try{await i.collection("user").where("wx_openid == '"+t+"'").get().then((t=>{if(0===t.result.errCode){let i=t.result.data[0];n.cloudAvatarPath=i.avatar?i.avatar:"",n.nickname=i.nickname?i.nickname:"请设置昵称",n.role=i.role?i.role:"ordinary",e.index.setStorageSync(a.globalData.cloudAvatarPathCacheName,i.avatar),e.index.setStorageSync(a.globalData.nicknameCacheName,i.nickname),e.index.setStorageSync(a.globalData.roleCacheName,i.role)}})).catch()}catch(o){}},httpRequest:(t,a)=>new Promise((i=>{e.index.request({url:t,data:a,success:e=>{i(e)},fail:()=>{i(void 0)}})})),async getCalendarInfo(){let t=this;try{let i=(await n.getCurrentDate()).data.currentDate.slice(0,10),o=e.index.getStorageSync(a.globalData.calendarCacheName);if(o&&o.date===i)return;let c="https://api.djapi.cn/wannianli/get",s={date:i,cn_to_unicode:"1",token:"37555a616248cb486ca0e60c10eca164",datatype:"json"},l=(await t.httpRequest(c,s)).data.Result,r={};r.date=i,r.year=l.nianci.slice(0,3),r.month=l.nianci.slice(3,6),r.day=l.nianci.slice(6,9),r.zodiac=l.shengxiao,r.lunar=l.nongli.slice(3,7),r.solarTerm=l.jieqi,r.suitable=l.do,r.tapu=l.nodo,t.calendar=r,e.index.setStorageSync(a.globalData.calendarCacheName,r)}catch(i){}},chooseImage:t=>new Promise((a=>{e.index.chooseImage({count:t,sizeType:["compressed"],sourceType:["album"],success:e=>{a(e)},fail:()=>{a(void 0)}})})),compressImage:t=>new Promise((a=>{e.index.compressImage({src:t,quality:80,success:e=>{a(e.tempFilePath)},fail:()=>{a(t)}})})),getImageInfo:t=>new Promise((a=>{e.index.getImageInfo({src:t,success:e=>{a(e)},fail:()=>{a(void 0)}})})),async compressImgList(t){let a=this;try{let i=[];for(let n=0;n<t.length;n++){if(t[n].size/1024<500){i.push(t[n].path);continue}let o=await a.getImageInfo(t[n].path);if(!o)continue;let c=new Promise((t=>{e.index.createSelectorQuery().select("#myCanvas").fields({node:!0,size:!0}).exec((e=>{const a=e[0].node,n=a.getContext("2d"),c=o.height/o.width;a.width=o.width>750?750:o.width,a.height=a.width*c;let s=a.createImage();s.src=o.path,s.onload=()=>{n.drawImage(s,0,0,a.width,a.height),wx.canvasToTempFilePath({canvas:a,fileType:"jpg",success:e=>{i.push(e.tempFilePath),t(!0)},fail:()=>{t(!0)}},this)},s.onerror=()=>{t(!0)}}))}));await c}return i}catch(i){}},async onClickSetAvatar(){let t=this;try{let n=await t.chooseImage(1);if(!n)return;e.index.showLoading({title:"设置中...",mask:!0});let c=n.tempFiles;c=await t.compressImgList(n.tempFiles);for(let e=0;e<c.length;e++){let a=await t.compressImage(c[e]);c[e]=a}await e.pn.uploadFile({filePath:c[0],cloudPath:a.globalData.wx_openid+".avatar.jpg"}).then((async n=>{let c=n.fileID;t.cloudAvatarPath=c,e.index.setStorageSync(a.globalData.cloudAvatarPathCacheName,c),await i.collection("user").where("wx_openid == '"+a.globalData.wx_openid+"'").get().then((async e=>{if(0===e.result.errCode){let t=e.result.data[0]?e.result.data[0].avatar:"",a=[];t&&(a.push(t),await o.deleteCloudFiles(a))}})).catch(),await i.collection("user").where("wx_openid == '"+a.globalData.wx_openid+"'").update({avatar:c}).then().catch()})).catch(),e.index.hideLoading()}catch(n){e.index.hideLoading()}},onClickSetNickname(){let e=this;e.isShowPopup=!0,e.isShowSetNicknameView=!0,e.setNicknameContent=""},onClickSetNicknameMask(){let e=this;e.setNicknameContent="",e.isShowSetNicknameView=!1,e.isShowPopup=!1},inputNicknameContent(e){this.setNicknameContent=e.target.value},async onClickUploadNickname(){let t=this;try{let n=t.setNicknameContent;if(!n)return void e.index.showToast({title:"昵称不能为空",icon:"none"});e.index.showModal({title:"温馨提示",content:"是否设置该昵称",success:async o=>{o.confirm&&(e.index.showLoading({title:"设置中...",mask:!0}),await i.collection("user").where("wx_openid == '"+a.globalData.wx_openid+"'").update({nickname:n}).then((()=>{t.nickname=n,e.index.setStorageSync(a.globalData.nicknameCacheName,n),t.onClickSetNicknameMask(),e.index.hideLoading(),e.index.showToast({title:"设置成功",icon:"none"})})).catch((()=>{t.onClickSetNicknameMask(),e.index.hideLoading()})))}})}catch(n){t.onClickSetNicknameMask(),e.index.hideLoading()}},onClickSetNotice(){let e=this;e.isShowPopup=!0,e.isShowSetNoticeView=!0,e.setNoticeContent=""},onClickSetNoticeMask(){let e=this;e.setNoticeContent="",e.isShowSetNoticeView=!1,e.isShowPopup=!1},inputNoticeContent(e){this.setNoticeContent=e.target.value},async onClickUploadNotice(){let t=this;try{let a=t.setNoticeContent;if(!a)return void e.index.showToast({title:"公告不能为空",icon:"none"});e.index.showModal({title:"温馨提示",content:"是否设置该公告",success:async o=>{o.confirm&&(e.index.showLoading({title:"设置中...",mask:!0}),await i.collection("notice").where("_id == '62f49bb51ff3ac000168404b'").get().then((async o=>{if(0===o.result.errCode){let c=o.result.data[0]?o.result.data[0].noticeList:[],s=(await n.getCurrentDate()).data.currentDate,l={};l.notice=a,l.date=s,c.unshift(l),await i.collection("notice").where("_id == '62f49bb51ff3ac000168404b'").update({noticeList:c}).then((()=>{t.onClickSetNoticeMask(),e.index.hideLoading(),e.index.showToast({title:"设置成功",icon:"none"})})).catch((()=>{t.onClickSetNoticeMask(),e.index.hideLoading()}))}})).catch((()=>{t.onClickSetNoticeMask(),e.index.hideLoading()})))}})}catch(a){t.onClickSetNoticeMask(),e.index.hideLoading()}},onClickSuitAndAvoid(){let e=this;e.otherFunctionTitle="今日宜忌",e.otherFunctionContent="宜: "+e.calendar.suitable+"\n忌: "+e.calendar.tapu,e.isShowPopup=!0,e.isShowOtherFunctionView=!0},onClickOtherFunctionMask(){let e=this;e.isShowOtherFunctionView=!1,e.isShowPopup=!1,e.otherFunctionTitle="",e.otherFunctionContent=""},async onClickRandomJoke(){let t=this;try{e.index.showLoading({title:"生成中...",mask:!0});let a="https://api.vvhan.com/api/joke?type=json",i=await t.httpRequest(a);if(i&&i.data&&i.data.success){let e=i.data.joke,a=i.data.title;t.otherFunctionTitle=a,t.otherFunctionContent=e,t.isShowPopup=!0,t.isShowOtherFunctionView=!0}e.index.hideLoading()}catch(a){e.index.hideLoading()}},async onClickRandomSweetWorld(){let t=this;try{e.index.showLoading({title:"生成中...",mask:!0});let a="https://api.vvhan.com/api/love?type=json",i=await t.httpRequest(a);i&&i.data&&i.data.success&&(t.otherFunctionTitle="随机情话",t.otherFunctionContent=i.data.ishan,t.isShowPopup=!0,t.isShowOtherFunctionView=!0),e.index.hideLoading()}catch(a){e.index.hideLoading()}},async onClickAboutApp(){let e=this;try{e.getPraiseInfoFromCloud(),e.isShowPopup=!0,e.isShowAboutApp=!0}catch(t){}},onClickAboutAppMask(){this.isShowAboutApp=!1,this.isShowPopup=!1},async getPraiseInfoFromCloud(){let t=this;try{await i.collection("praise").where("_id == '6310654ce3e39a0001adc296'").get().then((i=>{if(0===i.result.errCode){let n=i.result.data[0]?i.result.data[0].praiseList:[];t.isPraiseApp=-1!==n.indexOf(a.globalData.wx_openid),t.praiseAppSum=n.length,e.index.setStorageSync(a.globalData.isPraiseAppCacheName,t.isPraiseApp),e.index.setStorageSync(a.globalData.praiseAppSumCacheName,t.praiseAppSum)}})).catch()}catch(n){}},async onClickPraiseApp(){let t=this;try{if(!0===t.isPraiseApp)return;await i.collection("praise").where("_id == '6310654ce3e39a0001adc296'").get().then((async n=>{if(0===n.result.errCode){let o=n.result.data[0]?n.result.data[0].praiseList:[];-1===o.indexOf(a.globalData.wx_openid)&&o.unshift(a.globalData.wx_openid),t.isPraiseApp=-1!==o.indexOf(a.globalData.wx_openid),t.praiseAppSum=o.length,e.index.setStorageSync(a.globalData.isPraiseAppCacheName,t.isPraiseApp),e.index.setStorageSync(a.globalData.praiseAppSumCacheName,t.praiseAppSum),e.index.showToast({title:"谢谢你，陌生人",icon:"none"}),await i.collection("praise").where("_id == '6310654ce3e39a0001adc296'").update({praiseList:o}).then().catch()}})).catch()}catch(n){}},async onClickFishCalendar(){let t=this;try{e.index.showLoading({title:"生成中...",mask:!0});let a="https://api.vvhan.com/api/moyu?type=json",i=await t.httpRequest(a);if(e.index.hideLoading(),i&&i.data&&i.data.url){let t=[];t.push(i.data.url),e.index.previewImage({current:i.data.url,urls:t,indicator:"none"})}}catch(a){e.index.hideLoading()}}}};var s=e._export_sfc(c,[["render",function(t,a,i,n,o,c){return e.e({a:"overflow:"+(o.isShowPopup?"hidden":"visible"),b:o.cloudAvatarPath?o.cloudAvatarPath:"../../static/img_default_avatar_icon.png",c:e.t(o.nickname),d:o.calendar.date},o.calendar.date?{e:e.t(o.calendar.date),f:e.t(o.calendar.lunar),g:e.t(o.calendar.year+" "+o.calendar.zodiac),h:e.t(o.calendar.month+" "+o.calendar.day),i:e.t(o.calendar.solarTerm)}:{},{j:e.o(((...e)=>c.onClickSetAvatar&&c.onClickSetAvatar(...e))),k:e.o(((...e)=>c.onClickSetNickname&&c.onClickSetNickname(...e))),l:"manager"===o.role},"manager"===o.role?{m:e.o(((...e)=>c.onClickSetNotice&&c.onClickSetNotice(...e)))}:{},{n:e.o(((...e)=>c.onClickSuitAndAvoid&&c.onClickSuitAndAvoid(...e))),o:e.o(((...e)=>c.onClickRandomJoke&&c.onClickRandomJoke(...e))),p:e.o(((...e)=>c.onClickRandomSweetWorld&&c.onClickRandomSweetWorld(...e))),q:e.o(((...e)=>c.onClickFishCalendar&&c.onClickFishCalendar(...e))),r:e.o(((...e)=>c.onClickAboutApp&&c.onClickAboutApp(...e))),s:!0===o.isShowSetNicknameView},!0===o.isShowSetNicknameView?{t:e.o(((...e)=>c.onClickSetNicknameMask&&c.onClickSetNicknameMask(...e))),v:e.o(((...e)=>c.inputNicknameContent&&c.inputNicknameContent(...e))),w:e.o(((...e)=>c.onClickUploadNickname&&c.onClickUploadNickname(...e)))}:{},{x:!0===o.isShowSetNoticeView},!0===o.isShowSetNoticeView?{y:e.o(((...e)=>c.onClickSetNoticeMask&&c.onClickSetNoticeMask(...e))),z:e.o(((...e)=>c.inputNoticeContent&&c.inputNoticeContent(...e))),A:e.o(((...e)=>c.onClickUploadNotice&&c.onClickUploadNotice(...e)))}:{},{B:!0===o.isShowOtherFunctionView},!0===o.isShowOtherFunctionView?{C:e.o(((...e)=>c.onClickOtherFunctionMask&&c.onClickOtherFunctionMask(...e))),D:e.t(o.otherFunctionTitle),E:e.t(o.otherFunctionContent)}:{},{F:!0===o.isShowAboutApp},!0===o.isShowAboutApp?{G:e.o(((...e)=>c.onClickAboutAppMask&&c.onClickAboutAppMask(...e))),H:e.t(o.aboutAppContent),I:e.o(((...e)=>c.onClickPraiseApp&&c.onClickPraiseApp(...e))),J:o.isPraiseApp?"../../static/img_praise_icon.png":"../../static/img_no_praise_icon.png",K:e.t(o.praiseAppSum)}:{})}]]);c.__runtimeHooks=2,wx.createPage(s);
